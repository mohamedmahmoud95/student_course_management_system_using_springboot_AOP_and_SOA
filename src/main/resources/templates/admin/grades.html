<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Grade Management - SCMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin: 0.25rem 0;
        }
        .sidebar .nav-link:hover {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            color: white;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">Admin Portal</h4>
                        <p class="text-white-50 small">Administrator</p>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/dashboard">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/students">
                                <i class="fas fa-user-graduate me-2"></i>
                                Students
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/courses">
                                <i class="fas fa-book me-2"></i>
                                Courses
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/enrollments">
                                <i class="fas fa-user-plus me-2"></i>
                                Enrollments
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/grades">
                                <i class="fas fa-chart-line me-2"></i>
                                Grades
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/notifications">
                                <i class="fas fa-bell me-2"></i>
                                Notifications
                                <span class="badge bg-danger ms-2" id="adminNotificationCount">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/swagger-ui.html">
                                <i class="fas fa-book me-2"></i>
                                API Docs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home me-2"></i>
                                Home
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Grade Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-primary" onclick="showAddGradeModal()">
                                <i class="fas fa-plus me-1"></i>
                                Add Grade
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>All Grades</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Student</th>
                                        <th>Course</th>
                                        <th>Score</th>
                                        <th>Comments</th>
                                        <th>Recorded Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="grade : ${grades}" th:attr="data-grade-id=${grade.id}">
                                        <td th:text="${grade.id}">1</td>
                                        <td th:text="${grade.student.name}">Student Name</td>
                                        <td th:text="${grade.course.title}">Course Title</td>
                                        <td>
                                            <span class="badge" 
                                                  th:classappend="${grade.score >= 90 ? 'bg-success' : 
                                                                  grade.score >= 80 ? 'bg-info' : 
                                                                  grade.score >= 70 ? 'bg-warning' : 'bg-danger'}"
                                                  th:text="${grade.score}">95.5</span>
                                        </td>
                                        <td th:text="${grade.comments}">Comments</td>
                                        <td th:text="${#temporals.format(grade.recordedDate, 'MMM dd, yyyy')}">Date</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" th:attr="onclick='viewGrade(' + ${grade.id} + ')'">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" th:attr="onclick='editGrade(' + ${grade.id} + ', ' + ${grade.score} + ', \'' + ${grade.comments} + '\')'">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" th:attr="onclick='deleteGrade(' + ${grade.id} + ')'">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Add Grade Modal -->
    <div class="modal fade" id="addGradeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Grade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addGradeForm">
                        <div class="mb-3">
                            <label for="studentSearch" class="form-label">Student</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="studentSearch" placeholder="Search for student by name or email..." onkeyup="searchStudents()">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchStudents()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="studentSearchResults" class="list-group mt-2" style="max-height: 200px; overflow-y: auto; display: none;"></div>
                            <input type="hidden" id="selectedStudentId" required>
                            <small class="form-text text-muted">Search for a student who is enrolled in the selected course</small>
                        </div>
                        <div class="mb-3">
                            <label for="courseSelect" class="form-label">Course</label>
                            <select class="form-select" id="courseSelect" required onchange="onCourseChange()">
                                <option value="">Select Course</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="gradeScore" class="form-label">Score (0-100)</label>
                            <input type="number" class="form-control" id="gradeScore" min="0" max="100" step="0.1" required>
                        </div>
                        <div class="mb-3">
                            <label for="gradeComments" class="form-label">Comments</label>
                            <textarea class="form-control" id="gradeComments" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addGrade()">Add Grade</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Grade Modal -->
    <div class="modal fade" id="editGradeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Grade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editGradeForm">
                        <input type="hidden" id="editGradeId">
                        <div class="mb-3">
                            <label for="editGradeScore" class="form-label">Score (0-100)</label>
                            <input type="number" class="form-control" id="editGradeScore" min="0" max="100" step="0.1" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGradeComments" class="form-label">Comments</label>
                            <textarea class="form-control" id="editGradeComments" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateGrade()">Update Grade</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Grade Details Modal -->
    <div class="modal fade" id="gradeDetailsModal" tabindex="-1" aria-labelledby="gradeDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gradeDetailsModalLabel">
                        <i class="fas fa-eye me-2"></i>Grade Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Content will be dynamically loaded -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showAddGradeModal() {
            document.getElementById('addGradeForm').reset();
            loadStudentsAndCourses();
            new bootstrap.Modal(document.getElementById('addGradeModal')).show();
        }
        
        function loadStudentsAndCourses() {
            // Load courses
            fetch('/api/courses')
                .then(response => response.json())
                .then(data => {
                    const courseSelect = document.getElementById('courseSelect');
                    courseSelect.innerHTML = '<option value="">Select Course</option>';
                    data.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title;
                        courseSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function searchStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const courseId = document.getElementById('courseSelect').value;
            
            if (!courseId) {
                alert('Please select a course first');
                return;
            }
            
            if (searchTerm.length < 2) {
                document.getElementById('studentSearchResults').style.display = 'none';
                return;
            }
            
            // Get students enrolled in the selected course
            fetch(`/api/enrollments/course/${courseId}`)
                .then(response => response.json())
                .then(enrollments => {
                    const studentIds = enrollments.map(e => e.student.id);
                    
                    // Get all students and filter by search term and enrollment
                    return fetch('/api/students')
                        .then(response => response.json())
                        .then(students => {
                            const filteredStudents = students.filter(student => 
                                studentIds.includes(student.id) && 
                                (student.name.toLowerCase().includes(searchTerm) || 
                                 student.email.toLowerCase().includes(searchTerm))
                            );
                            
                            displayStudentSearchResults(filteredStudents);
                        });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error searching students');
                });
        }
        
        function displayStudentSearchResults(students) {
            const resultsDiv = document.getElementById('studentSearchResults');
            resultsDiv.innerHTML = '';
            
            if (students.length === 0) {
                resultsDiv.innerHTML = '<div class="list-group-item text-muted">No enrolled students found</div>';
            } else {
                students.forEach(student => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = `${student.name} (${student.email})`;
                    item.onclick = () => selectStudent(student);
                    resultsDiv.appendChild(item);
                });
            }
            
            resultsDiv.style.display = 'block';
        }
        
        function selectStudent(student) {
            document.getElementById('studentSearch').value = student.name;
            document.getElementById('selectedStudentId').value = student.id;
            document.getElementById('studentSearchResults').style.display = 'none';
        }
        
        function onCourseChange() {
            // Clear student selection when course changes
            document.getElementById('studentSearch').value = '';
            document.getElementById('selectedStudentId').value = '';
            document.getElementById('studentSearchResults').style.display = 'none';
        }
        
        function addGrade() {
            const studentId = document.getElementById('selectedStudentId').value;
            const courseId = document.getElementById('courseSelect').value;
            const score = parseFloat(document.getElementById('gradeScore').value);
            const comments = document.getElementById('gradeComments').value;
            
            if (!studentId || !courseId || isNaN(score)) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Validate that student is enrolled in the course
            fetch(`/api/enrollments/check?studentId=${studentId}&courseId=${courseId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.enrolled) {
                        alert('Student is not enrolled in this course. Please select an enrolled student.');
                        return;
                    }
                    
                    // Proceed with adding the grade
                    submitGrade(studentId, courseId, score, comments);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error validating enrollment');
                });
        }
        
        function submitGrade(studentId, courseId, score, comments) {
            
            fetch('/api/admin/grades', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    studentId: parseInt(studentId),
                    courseId: parseInt(courseId),
                    score: score,
                    comments: comments
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Grade added successfully');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding grade');
            });
        }
        
        function viewGrade(gradeId) {
            // Find the grade data from the current page
            const row = document.querySelector(`tr[data-grade-id="${gradeId}"]`);
            if (row) {
                const studentName = row.querySelector('td:nth-child(2)').textContent;
                const courseName = row.querySelector('td:nth-child(3)').textContent;
                const score = row.querySelector('td:nth-child(4)').textContent;
                const comments = row.querySelector('td:nth-child(5)').textContent;
                const recordedDate = row.querySelector('td:nth-child(6)').textContent;
                
                const modal = document.getElementById('gradeDetailsModal');
                const modalBody = modal.querySelector('.modal-body');
                
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-id-badge text-primary"></i> Grade ID</h6>
                            <p class="mb-3">${gradeId}</p>
                            
                            <h6><i class="fas fa-user-graduate text-success"></i> Student</h6>
                            <p class="mb-3">${studentName}</p>
                            
                            <h6><i class="fas fa-book text-info"></i> Course</h6>
                            <p class="mb-3">${courseName}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-line text-warning"></i> Score</h6>
                            <p class="mb-3"><span class="badge bg-primary">${score}</span></p>
                            
                            <h6><i class="fas fa-calendar text-secondary"></i> Recorded Date</h6>
                            <p class="mb-3">${recordedDate}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h6><i class="fas fa-comment text-muted"></i> Comments</h6>
                            <p class="mb-3">${comments || 'No comments provided'}</p>
                        </div>
                    </div>
                `;
                
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            } else {
                alert('Grade details not found on current page');
            }
        }
        
        function editGrade(gradeId, score, comments) {
            document.getElementById('editGradeId').value = gradeId;
            document.getElementById('editGradeScore').value = score;
            document.getElementById('editGradeComments').value = comments || '';
            new bootstrap.Modal(document.getElementById('editGradeModal')).show();
        }
        
        function updateGrade() {
            const gradeId = document.getElementById('editGradeId').value;
            const score = parseFloat(document.getElementById('editGradeScore').value);
            const comments = document.getElementById('editGradeComments').value;
            
            if (isNaN(score)) {
                alert('Please enter a valid score');
                return;
            }
            
            fetch(`/api/admin/grades/${gradeId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    score: score,
                    comments: comments
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Grade updated successfully');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating grade');
            });
        }
        
        function deleteGrade(gradeId) {
            if (confirm('Are you sure you want to delete this grade?')) {
                fetch(`/api/admin/grades/${gradeId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Grade deleted successfully');
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting grade');
                });
            }
        }
    </script>
</body>
</html>
